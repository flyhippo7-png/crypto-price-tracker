<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>로딩 중...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0f1115;color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;padding:28px}
    h1{margin:0 0 14px;text-align:center}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:8px auto 18px}
    .controls>*{background:#1f1f1f;color:#fff;border:none;border-radius:8px;padding:9px 11px;font-size:14px}
    .controls input{min-width:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;max-width:1200px;margin:0 auto}
    .card{background:#1a1d23;border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .sym{font-weight:700;margin-bottom:6px;letter-spacing:.3px}
    .price{font-size:22px;font-weight:800;margin:6px 0}
    .up{color:#00e676}
    .down{color:#ff5252}
    .muted{opacity:.7;font-size:12px}
    .badge{display:inline-block;margin-top:6px;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.up{background:rgba(0,230,118,.15);color:#00e676;border:1px solid rgba(0,230,118,.4)}
    .badge.down{background:rgba(255,82,82,.15);color:#ff5252;border:1px solid rgba(255,82,82,.4)}
    .status{ text-align:center; margin:10px auto 0; font-size:12px; color:#aaa; max-width:960px }
    .error{ color:#ff8a80 }
    .log{white-space:pre-wrap;background:#101318;border:1px solid #2a2f3a;border-radius:8px;padding:10px;max-width:960px;margin:10px auto 0;font-size:12px;color:#c7cfe2}
  </style>
</head>
<body>
  <h1>바이낸스 실시간 코인 가격</h1>

  <div class="controls">
    <label style="background:none;padding:0">탭 제목 코인</label>
    <select id="titleCoin"></select>

    <input id="addInput" placeholder="추가할 코인 (예: ADA 또는 ADAUSDT)" />
    <button id="addBtn">코인 추가</button>
    <button id="refreshBtn">연결 재시도</button>
  </div>

  <div class="grid" id="grid"></div>
  <div class="status" id="status">초기화 중…</div>
  <div class="log" id="log" style="display:none"></div>

  <script>
    // ===== 초기 목록 (알파벳) =====
    const initialCoins = [
      'ACM','ALICE','ALGO','APT','ASTR','BNB','BTC','CETUS','CRV','DYDX','DUSK','EIGEN','ETH','FIDA','FIL','FLOW','GMT','ICP','ICX','JASMY','NEAR','NEO','NMR','OG','POL','POWR','PUNDIX','QI','QNT','QTUM','RARE','RDNT','REI','SOL','T','TIA','WOO','XEC','XVG','YGG','ZEN','ZEC'
    ];

    // ===== 상태 =====
    let coins = []; // 소문자 usdt 접미어
    const lastPrice = new Map();
    const curPrice  = new Map();
    const changePct = new Map();

    let ws = null;
    let reconnectDelay = 1000;
    let lastMsgTS = 0;
    let mode = 'combined'; // 'combined' | 'arr'

    const grid = document.getElementById('grid');
    const titleSel = document.getElementById('titleCoin');
    const addInput = document.getElementById('addInput');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    function log(msg){
      logEl.style.display='block';
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function normalize(sym){
      if(!sym) return '';
      sym = sym.trim().toLowerCase();
      if(!sym) return '';
      return sym.endsWith('usdt') ? sym : sym + 'usdt';
    }
    function displayName(sym){
      return sym.replace('usdt','').toUpperCase() + '/USDT';
    }
    function buildStreams(){
      return coins.map(s => s + '@miniTicker').join('/'); // miniTicker가 trade보다 안정적
    }
    function setStatus(msg, err=false){
      statusEl.textContent = msg;
      statusEl.className = 'status' + (err?' error':'');
      log(msg);
    }

    function ensureCard(sym){
      if(document.getElementById(sym)) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="sym">${displayName(sym)}</div>
        <div class="price" id="${sym}">로딩 중…</div>
        <div class="badge" id="chg-${sym}" style="display:none"></div>
        <div class="muted" id="note-${sym}"></div>
      `;
      grid.appendChild(card);
    }

    function updateCard(sym, priceStr){
      const el = document.getElementById(sym);
      if(!el) return;
      const last = lastPrice.get(sym);
      if(last !== undefined){
        el.className = 'price ' + (parseFloat(priceStr) > parseFloat(last) ? 'up' : parseFloat(priceStr) < parseFloat(last) ? 'down' : '');
      } else { el.className = 'price'; }
      el.textContent = `$${priceStr}`;
      lastPrice.set(sym, priceStr);

      const chg = changePct.get(sym);
      const badge = document.getElementById('chg-'+sym);
      if(badge){
        if(typeof chg === 'number' && Math.abs(chg) >= 10){
          badge.style.display = 'inline-block';
          badge.className = 'badge ' + (chg>0?'up':'down');
          badge.textContent = `${chg.toFixed(2)}% ${chg>0?'상승':'하락'}`;
        } else { badge.style.display = 'none'; }
      }
    }

    function updateTitle(sym){
      const p = curPrice.get(sym);
      const tag = sym.replace('usdt','').toUpperCase();
      document.title = p ? `$${p} - ${tag}` : `로딩 중... - ${tag}`;
    }

    async function fetch24hChanges(){
      await Promise.all(coins.map(async sym=>{
        try{
          const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym.toUpperCase()}`);
          if(!r.ok) return; const d = await r.json();
          const pct = parseFloat(d.priceChangePercent);
          if(!Number.isNaN(pct)) changePct.set(sym, pct);
        }catch(e){ log(`24h 실패 ${sym}: ${e?.message||e}`); }
      }));
      coins.forEach(sym=>{ const p = curPrice.get(sym); if(p) updateCard(sym,p); });
    }

    function connectWS(){
      if(ws){ try{ ws.close(); }catch(_){} ws=null; }
      lastMsgTS = Date.now();
      const url = (mode==='combined')
        ? `wss://stream.binance.com:9443/stream?streams=${buildStreams()}`
        : `wss://stream.binance.com:9443/ws/!miniTicker@arr`;

      setStatus(`실시간 연결 중… (mode=${mode})`);
      ws = new WebSocket(url);

      ws.onopen = ()=>{ setStatus('실시간 연결 완료'); reconnectDelay=1000; };

      ws.onmessage = (evt)=>{
        lastMsgTS = Date.now();
        try{
          const payload = JSON.parse(evt.data);
          if(mode==='combined'){
            const d = payload.data; if(!d||!d.s) return;
            const sym = d.s.toLowerCase();
            const priceStr = parseFloat(d.c ?? d.p).toFixed(sym==='jasmyusdt'?6:2); // miniTicker.c or trade.p
            curPrice.set(sym, priceStr);
            updateCard(sym, priceStr);
            if(titleSel.value===sym) updateTitle(sym);
          } else { // arr mode: 배열 전체
            const arr = Array.isArray(payload) ? payload : payload.data;
            if(!Array.isArray(arr)) return;
            // 관심 심볼만 업데이트
            for(const it of arr){
              const s = it.s?.toLowerCase?.();
              if(!s || !coins.includes(s)) continue;
              const priceStr = parseFloat(it.c).toFixed(s==='jasmyusdt'?6:2);
              curPrice.set(s, priceStr);
              updateCard(s, priceStr);
              if(titleSel.value===s) updateTitle(s);
            }
          }
        }catch(e){ log('메시지 파싱 실패: '+(e?.message||e)); }
      };

      ws.onclose = ()=>{
        setStatus('연결 끊김 – 재시도 대기…');
        setTimeout(()=>{ connectWS(); }, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay*2, 30000);
      };

      ws.onerror = (e)=>{
        setStatus('실시간 연결 오류', true);
        log('WS error: '+(e?.message||e));
        try{ ws.close(); }catch(_){}
      };

      // 7초 동안 메시지가 없으면 arr 모드로 자동 전환 (혹시 스트림 조합이 막힌 환경 대비)
      setTimeout(()=>{
        if(Date.now()-lastMsgTS > 7000){
          mode = (mode==='combined') ? 'arr' : 'combined';
          setStatus(`메시지 무응답 → 모드 전환: ${mode}`);
          connectWS();
        }
      }, 7500);
    }

    function rebuildUI(){
      titleSel.innerHTML=''; grid.innerHTML='';
      coins.sort();
      coins.forEach(sym=>{
        ensureCard(sym);
        const opt = document.createElement('option');
        opt.value = sym; opt.textContent = displayName(sym);
        titleSel.appendChild(opt);
      });
      if(!coins.includes(titleSel.value)) titleSel.value = coins[0] || '';
      if(titleSel.value) updateTitle(titleSel.value);
    }

    async function addSymbolFromInput(){
      let raw = addInput.value; if(!raw) return; addInput.value='';
      const sym = normalize(raw);
      if(coins.includes(sym)) { setStatus(`${displayName(sym)} 이미 추가됨`); return; }
      coins.push(sym); rebuildUI(); connectWS(); fetch24hChanges();
      setStatus(`${displayName(sym)} 추가됨`);
    }

    (async function init(){
      const set = new Set(initialCoins.map(c=>normalize(c)));
      coins = [...set];
      rebuildUI();
      connectWS();
      fetch24hChanges();
      setInterval(fetch24hChanges, 5*60*1000);
    })();

    addBtn.addEventListener('click', addSymbolFromInput);
    addInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addSymbolFromInput(); });
    refreshBtn.addEventListener('click', ()=>{ connectWS(); fetch24hChanges(); });
    titleSel.addEventListener('change', ()=> updateTitle(titleSel.value));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>로딩 중...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f1115;--card:#1a1d23;--panel:#12151c;--muted:#97a0b8;--ok:#00e676;--warn:#ffca28;--err:#ff5252;--border:#2a2f3a}
    *{box-sizing:border-box}
    body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;padding:0}
    .layout{display:grid;grid-template-columns: 1fr 320px;gap:16px;min-height:100vh;padding:20px}
    header{grid-column:1 / -1;text-align:center}
    h1{margin:0 0 8px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:8px auto 18px}
    .controls>*{background:#1f1f1f;color:#fff;border:none;border-radius:8px;padding:9px 11px;font-size:14px}
    .controls input{min-width:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);position:relative}
    .sym{font-weight:700;margin-bottom:6px;letter-spacing:.3px}
    .price{font-size:22px;font-weight:800;margin:6px 0;display:flex;align-items:center;gap:6px}
    .dir{font-weight:900}
    .dir.up{color:var(--ok)}
    .dir.down{color:var(--err)}
    .up{color:var(--ok)}
    .down{color:var(--err)}
    .muted{opacity:.7;font-size:12px}
    .badge{display:inline-block;margin-top:6px;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.up{background:rgba(0,230,118,.15);color:var(--ok);border:1px solid rgba(0,230,118,.4)}
    .badge.down{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.4)}
    .del{position:absolute;top:8px;right:8px;background:#2a2f3a;border:1px solid #3a4150;border-radius:6px;font-size:12px;padding:4px 8px;color:#cfd6e6;cursor:pointer}
    .del:hover{background:#353c4b}
    .status{ text-align:center; margin:10px auto 0; font-size:12px; color:#aaa; max-width:960px }
    .error{ color:#ff8a80 }
    .log{white-space:pre-wrap;background:#101318;border:1px solid var(--border);border-radius:8px;padding:10px;max-width:960px;margin:10px auto 0;font-size:12px;color:#c7cfe2}
    /* 오른쪽 패널 */
    aside.status-panel{position:sticky;top:20px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;height:fit-content}
    .row{display:flex;justify-content:space-between;gap:10px;font-size:14px}
    .k{opacity:.7}
    .v{font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .ok{background:rgba(0,230,118,.15);color:var(--ok);border:1px solid rgba(0,230,118,.4)}
    .err{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.4)}
    .hr{height:1px;background:var(--border);margin:2px 0}
    .list{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px solid var(--border);background:#171a21;padding:4px 8px;border-radius:999px;font-size:12px}
    @media(max-width:960px){.layout{grid-template-columns:1fr}} /* 모바일에서는 패널 아래로 */
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>바이낸스 실시간 코인 가격</h1>
      <div class="controls">
        <label style="background:none;padding:0">탭 제목 코인</label>
        <select id="titleCoin"></select>
        <input id="addInput" placeholder="추가할 코인 (예: ADA 또는 ADAUSDT)" />
        <button id="addBtn">코인 추가</button>
        <button id="refreshBtn">연결 재시도</button>
      </div>
    </header>

    <main>
      <div class="grid" id="grid"></div>
      <div class="status" id="status">초기화 중…</div>
      <div class="log" id="log" style="display:none"></div>
    </main>

    <aside class="status-panel" id="panel">
      <div class="row"><span class="k">연결 상태</span><span class="v"><span id="connTag" class="tag ok">연결됨</span></span></div>
      <div class="row"><span class="k">모드</span><span class="v" id="mode">combined</span></div>
      <div class="row"><span class="k">마지막 수신</span><span class="v" id="last">-</span></div>
      <div class="row"><span class="k">구독 심볼</span><span class="v" id="count">0개</span></div>
      <div class="hr"></div>
      <div class="row"><span class="k">재연결 대기</span><span class="v" id="backoff">1.0s</span></div>
      <div class="hr"></div>
      <div class="list" id="symbols"></div>
    </aside>
  </div>

  <script>
    // ===== 초기 목록 (알파벳) =====
    const initialCoins = [
      'ACM','ALICE','ALGO','APT','ASTR','BNB','BTC','CETUS','CRV','DYDX','DUSK','EIGEN','ETH','FIDA','FIL','FLOW','GMT','ICP','ICX','JASMY','NEAR','NEO','NMR','OG','POL','POWR','PUNDIX','QI','QNT','QTUM','RARE','RDNT','REI','SOL','T','TIA','WOO','XEC','XVG','YGG','ZEN','ZEC'
    ];

    // ===== 상태 =====
    let coins = []; // 소문자 usdt 접미어
    const lastPrice = new Map();
    const curPrice  = new Map();
    const dirMap    = new Map(); // -1 하락, 0 유지, 1 상승
    const changePct = new Map();

    let ws = null;
    let reconnectDelay = 1000;
    let lastMsgTS = 0;
    let mode = 'combined'; // 'combined' | 'arr'
    let connected = false;

    // 탭 깜박임 관련
    let blinkTimer = null;
    let blinkActive = false; // 끊겼을 때만 true
    let blinkOn = false;

    const grid = document.getElementById('grid');
    const titleSel = document.getElementById('titleCoin');
    const addInput = document.getElementById('addInput');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    // 패널 요소
    const connTag = document.getElementById('connTag');
    const modeEl = document.getElementById('mode');
    const lastEl = document.getElementById('last');
    const countEl = document.getElementById('count');
    const backoffEl = document.getElementById('backoff');
    const symListEl = document.getElementById('symbols');

    function log(msg){
      logEl.style.display='block';
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function normalize(sym){
      if(!sym) return '';
      sym = sym.trim().toLowerCase();
      if(!sym) return '';
      return sym.endsWith('usdt') ? sym : sym + 'usdt';
    }
    function displayName(sym){
      return sym.replace('usdt','').toUpperCase() + '/USDT';
    }
    function buildStreams(){
      return coins.map(s => s + '@miniTicker').join('/'); // miniTicker가 trade보다 안정적
    }
    function setStatus(msg, err=false){
      statusEl.textContent = msg;
      statusEl.className = 'status' + (err?' error':'');
      log(msg);
    }

    function ensureCard(sym){
      if(document.getElementById(sym)) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <button class="del" data-sym="${sym}" title="삭제">삭제</button>
        <div class="sym">${displayName(sym)}</div>
        <div class="price" id="${sym}">
          <span class="dir" id="dir-${sym}"></span>
          <span class="amt" id="amt-${sym}">로딩 중…</span>
        </div>
        <div class="badge" id="chg-${sym}" style="display:none"></div>
        <div class="muted" id="note-${sym}"></div>
      `;
      grid.appendChild(card);
    }

    function updatePanel(){
      connTag.textContent = connected ? '연결됨' : '끊김';
      connTag.className = 'tag ' + (connected ? 'ok' : 'err');
      modeEl.textContent = mode;
      countEl.textContent = coins.length + '개';
      backoffEl.textContent = (reconnectDelay/1000).toFixed(1) + 's';
      symListEl.innerHTML = '';
      coins.forEach(s=>{ const chip = document.createElement('div'); chip.className='chip'; chip.textContent=s.toUpperCase(); symListEl.appendChild(chip); });
    }

    function setDirSymbol(sym, dir){
      const dEl = document.getElementById('dir-'+sym);
      if(!dEl) return;
      if(dir>0){ dEl.textContent='▲'; dEl.className='dir up'; }
      else if(dir<0){ dEl.textContent='▼'; dEl.className='dir down'; }
      // dir==0 은 이전 상태 유지 (변경 없음)
    }

    function updateCard(sym, priceStr, dir){
      const elAmt = document.getElementById('amt-'+sym);
      const priceBox = document.getElementById(sym);
      if(!elAmt || !priceBox) return;
      const last = lastPrice.get(sym);
      if(last !== undefined){
        priceBox.className = 'price ' + (parseFloat(priceStr) > parseFloat(last) ? 'up' : parseFloat(priceStr) < parseFloat(last) ? 'down' : '');
      } else { priceBox.className = 'price'; }
      elAmt.textContent = `$${priceStr}`;
      lastPrice.set(sym, priceStr);
      if(dir!==undefined) setDirSymbol(sym, dir);

      const chg = changePct.get(sym);
      const badge = document.getElementById('chg-'+sym);
      if(badge){
        if(typeof chg === 'number' && Math.abs(chg) >= 10){
          badge.style.display = 'inline-block';
          badge.className = 'badge ' + (chg>0?'up':'down');
          badge.textContent = `${chg.toFixed(2)}% ${chg>0?'상승':'하락'}`;
        } else { badge.style.display = 'none'; }
      }
    }

    // === 동적 파비콘(탭 아이콘)으로 방향/색상 표현 ===
    function setFaviconSymbol(dir){
      let link = document.querySelector('link[rel="icon"]');
      if(!link){ link = document.createElement('link'); link.rel='icon'; document.head.appendChild(link); }
      const c = document.createElement('canvas'); c.width=128; c.height=128; const ctx=c.getContext('2d');
      ctx.clearRect(0,0,128,128);
      ctx.fillStyle = '#000000'; ctx.fillRect(0,0,128,128); // 배경 검정
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='bold 96px Arial';
      if(dir>0){ ctx.fillStyle = '#00e676'; ctx.fillText('▲',64,78); }
      else if(dir<0){ ctx.fillStyle = '#ff5252'; ctx.fillText('▼',64,78); }
      else { ctx.fillStyle = '#000000'; ctx.fillText('•',64,78); }
      link.href = c.toDataURL('image/png');
    }

    // 탭 제목 업데이트 (깜박임 프리픽스 + 방향 기호 포함)
    function updateTitle(sym){
      const p = curPrice.get(sym);
      const tag = sym.replace('usdt','').toUpperCase();
      const dir = dirMap.get(sym) || 0;
      const tri = dir>0?'▲':dir<0?'▼':''; // 변동 없으면 이전값 유지 -> dirMap 사용
      const base = p ? `${tri} $${p} - ${tag}` : `${tri?tri+' ':''}로딩 중... - ${tag}`;
      const prefix = (blinkActive && blinkOn) ? '재연결 중… ' : '';
      document.title = prefix + base;
      setFaviconSymbol(dir);
    }

    async function fetch24hChanges(){
      await Promise.all(coins.map(async sym=>{
        try{
          const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym.toUpperCase()}`);
          if(!r.ok) return; const d = await r.json();
          const pct = parseFloat(d.priceChangePercent);
          if(!Number.isNaN(pct)) changePct.set(sym, pct);
        }catch(e){ log(`24h 실패 ${sym}: ${e?.message||e}`); }
      }));
      coins.forEach(sym=>{ const p = curPrice.get(sym); if(p) updateCard(sym,p,dirMap.get(sym)); });
    }

    function startBlink(){
      if(blinkTimer) return; blinkActive = true; blinkOn = true;
      blinkTimer = setInterval(()=>{ blinkOn = !blinkOn; if(titleSel.value) updateTitle(titleSel.value); }, 600);
    }
    function stopBlink(){
      if(!blinkTimer) return; clearInterval(blinkTimer); blinkTimer=null; blinkActive=false; blinkOn=false; if(titleSel.value) updateTitle(titleSel.value);
    }

    function connectWS(){
      if(ws){ try{ ws.close(); }catch(_){} ws=null; }
      lastMsgTS = Date.now();
      const url = (mode==='combined')
        ? `wss://stream.binance.com:9443/stream?streams=${buildStreams()}`
        : `wss://stream.binance.com:9443/ws/!miniTicker@arr`;

      setStatus(`실시간 연결 중… (mode=${mode})`);
      ws = new WebSocket(url);

      ws.onopen = ()=>{ connected = true; stopBlink(); setStatus('실시간 연결 완료'); reconnectDelay=1000; updatePanel(); if(titleSel.value) updateTitle(titleSel.value); };

      ws.onmessage = (evt)=>{
        lastMsgTS = Date.now();
        if(!connected){ connected=true; stopBlink(); updatePanel(); }
        try{
          const payload = JSON.parse(evt.data);
          if(mode==='combined'){
            const d = payload.data; if(!d||!d.s) return;
            const sym = d.s.toLowerCase();
            const prev = curPrice.get(sym) ?? lastPrice.get(sym);
            const priceStr = parseFloat(d.c ?? d.p).toFixed(sym==='jasmyusdt'?6:2); // miniTicker.c or trade.p
            curPrice.set(sym, priceStr);
            let dir = 0;
            if(prev !== undefined){ const pv=parseFloat(prev), cv=parseFloat(priceStr); dir = cv>pv?1:cv<pv?-1:0; }
            if(dir!==0) dirMap.set(sym, dir);
            updateCard(sym, priceStr, dir===0?undefined:dir);
            if(titleSel.value===sym) updateTitle(sym);
          } else { // arr mode
            const arr = Array.isArray(payload) ? payload : payload.data;
            if(!Array.isArray(arr)) return;
            for(const it of arr){
              const s = it.s?.toLowerCase?.(); if(!s || !coins.includes(s)) continue;
              const prev = curPrice.get(s) ?? lastPrice.get(s);
              const priceStr = parseFloat(it.c).toFixed(s==='jasmyusdt'?6:2);
              curPrice.set(s, priceStr);
              let dir = 0;
              if(prev !== undefined){ const pv=parseFloat(prev), cv=parseFloat(priceStr); dir = cv>pv?1:cv<pv?-1:0; }
              if(dir!==0) dirMap.set(s, dir);
              updateCard(s, priceStr, dir===0?undefined:dir);
              if(titleSel.value===s) updateTitle(s);
            }
          }
          lastEl.textContent = new Date().toLocaleTimeString();
        }catch(e){ log('메시지 파싱 실패: '+(e?.message||e)); }
      };

      ws.onclose = ()=>{
        connected = false; startBlink(); updatePanel(); if(titleSel.value) updateTitle(titleSel.value);
        setStatus('연결 끊김 – 재시도 대기…');
        setTimeout(()=>{ connectWS(); }, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay*2, 30000);
      };

      ws.onerror = (e)=>{
        connected = false; startBlink(); updatePanel(); if(titleSel.value) updateTitle(titleSel.value);
        setStatus('실시간 연결 오류', true);
        log('WS error: '+(e?.message||e));
        try{ ws.close(); }catch(_){}
      };

      // 7초 무응답 시 모드 전환
      setTimeout(()=>{
        if(Date.now()-lastMsgTS > 7000){
          mode = (mode==='combined') ? 'arr' : 'combined';
          setStatus(`메시지 무응답 → 모드 전환: ${mode}`);
          updatePanel();
          connectWS();
        }
      }, 7500);
    }

    function rebuildUI(){
      const prevSel = titleSel.value;
      titleSel.innerHTML=''; grid.innerHTML='';
      coins.sort();
      coins.forEach(sym=>{
        ensureCard(sym);
        const opt = document.createElement('option');
        opt.value = sym; opt.textContent = displayName(sym);
        titleSel.appendChild(opt);
      });
      titleSel.value = coins.includes(prevSel) ? prevSel : (coins[0] || '');
      if(titleSel.value) updateTitle(titleSel.value);
      updatePanel();
    }

    function removeSymbol(sym){
      const idx = coins.indexOf(sym);
      if(idx === -1) return;
      coins.splice(idx,1);
      lastPrice.delete(sym); curPrice.delete(sym); changePct.delete(sym); dirMap.delete(sym);
      const priceEl = document.getElementById(sym);
      if(priceEl){ const card = priceEl.closest('.card'); if(card) card.remove(); }
      if(titleSel.value === sym){
        titleSel.value = coins[0] || '';
        if(titleSel.value) updateTitle(titleSel.value); else document.title = '코인 가격';
      }
      const prevSel = titleSel.value;
      titleSel.innerHTML='';
      coins.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=displayName(s); titleSel.appendChild(o); });
      titleSel.value = prevSel && coins.includes(prevSel) ? prevSel : (coins[0]||'');
      connectWS();
      fetch24hChanges();
      updatePanel();
      setStatus(`${displayName(sym)} 제거됨`);
    }

    async function addSymbolFromInput(){
      let raw = addInput.value; if(!raw) return; addInput.value='';
      const sym = normalize(raw);
      if(coins.includes(sym)) { setStatus(`${displayName(sym)} 이미 추가됨`); return; }
      coins.push(sym); rebuildUI(); connectWS(); fetch24hChanges();
      setStatus(`${displayName(sym)} 추가됨`);
    }

    // 이벤트 위임: 삭제 버튼
    document.getElementById('grid').addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const sym = btn.dataset.sym;
      if(sym) removeSymbol(sym);
    });

    (async function init(){
      const set = new Set(initialCoins.map(c=>normalize(c)));
      coins = [...set];
      // 초기 파비콘은 방향 없음
      setFaviconSymbol(0);
      rebuildUI();
      connectWS();
      fetch24hChanges();
      setInterval(fetch24hChanges, 5*60*1000);
      // 패널 시간 표기 keep-alive
      setInterval(()=>{ lastEl.textContent = new Date().toLocaleTimeString(); }, 2000);
    })();

    addBtn.addEventListener('click', addSymbolFromInput);
    addInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addSymbolFromInput(); });
    refreshBtn.addEventListener('click', ()=>{ connectWS(); fetch24hChanges(); });
    titleSel.addEventListener('change', ()=> updateTitle(titleSel.value));
  </script>
</body>
</html>

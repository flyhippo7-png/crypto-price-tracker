<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>로딩 중...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0f1115;color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;padding:32px}
    h1{margin:0 0 16px;text-align:center}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:8px auto 20px}
    .controls>*{background:#1f1f1f;color:#fff;border:none;border-radius:8px;padding:10px 12px;font-size:14px}
    .controls input{min-width:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;max-width:1200px;margin:0 auto}
    .card{background:#1a1d23;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .sym{font-weight:700;margin-bottom:6px;letter-spacing:.3px}
    .price{font-size:22px;font-weight:800;margin:6px 0}
    .up{color:#00e676}
    .down{color:#ff5252}
    .muted{opacity:.7;font-size:12px}
    .badge{display:inline-block;margin-top:6px;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.up{background:rgba(0,230,118,.15);color:#00e676;border:1px solid rgba(0,230,118,.4)}
    .badge.down{background:rgba(255,82,82,.15);color:#ff5252;border:1px solid rgba(255,82,82,.4)}
    .status{ text-align:center; margin:10px 0 0; font-size:12px; color:#aaa }
    .error{ color:#ff8a80 }
  </style>
</head>
<body>
  <h1>바이낸스 실시간 코인 가격</h1>

  <div class="controls">
    <label style="background:none;padding:0">탭 제목 코인</label>
    <select id="titleCoin"></select>

    <input id="addInput" placeholder="추가할 코인 (예: ADA 또는 ADAUSDT)" />
    <button id="addBtn">코인 추가</button>
    <button id="refreshBtn">연결 재시도</button>
  </div>

  <div class="grid" id="grid"></div>
  <div class="status" id="status">초기화 중…</div>

  <script>
    // ===== 설정 =====
    // 초기 코인 목록 (원하신 확장 반영 + 알파벳 정렬)
    const initialCoins = [
      'ACM','ALICE','ALGO','APT','ASTR','BNB','BTC','CETUS','CRV','DYDX','DUSK','EIGEN','ETH','FIDA','FIL','FLOW','GMT','ICP','ICX','JASMY','NEAR','NEO','NMR','OG','POL','POWR','PUNDIX','QI','QNT','QTUM','RARE','RDNT','REI','SOL','T','TIA','WOO','XEC','XVG','YGG','ZEN','ZEC'
    ];

    // ===== 상태 =====
    let coins = [];// 심볼은 모두 소문자 usdt 접미
    const names = new Map(); // symbol -> 이름표시 (e.g. BTC/USDT)
    const lastPrice = new Map(); // symbol -> 마지막 가격(문자열)
    const curPrice = new Map();  // symbol -> 현재 가격(문자열)
    const changePct = new Map(); // symbol -> 24h % (숫자)

    let ws = null; // WebSocket 핸들
    let reconnectDelay = 1000; // 지수 백오프 시작

    const grid = document.getElementById('grid');
    const titleSel = document.getElementById('titleCoin');
    const addInput = document.getElementById('addInput');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');

    // 유틸: 심볼 정규화 ("ada" 또는 "adausdt" -> "adausdt")
    function normalize(sym){
      if(!sym) return '';
      sym = sym.trim().toLowerCase();
      if(!sym) return '';
      if(sym.endsWith('usdt')) return sym;
      return sym + 'usdt';
    }

    function displayName(sym){
      return sym.replace('usdt','').toUpperCase() + '/USDT';
    }

    function buildStreams(){
      return coins.map(s => s + '@trade').join('/');
    }

    function setStatus(msg, isError=false){
      statusEl.textContent = msg;
      statusEl.className = 'status' + (isError ? ' error' : '');
    }

    // DOM에 카드 생성
    function ensureCard(sym){
      if(document.getElementById(sym)) return; // 이미 존재
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="sym">${displayName(sym)}</div>
        <div class="price" id="${sym}">로딩 중…</div>
        <div class="badge" id="chg-${sym}" style="display:none"></div>
        <div class="muted" id="note-${sym}"></div>
      `;
      grid.appendChild(card);
    }

    // 카드 업데이트 (가격/색상/변동률)
    function updateCard(sym, priceStr){
      const priceEl = document.getElementById(sym);
      if(!priceEl) return;
      const last = lastPrice.get(sym);
      if(last !== undefined){
        priceEl.className = 'price ' + (parseFloat(priceStr) > parseFloat(last) ? 'up' : parseFloat(priceStr) < parseFloat(last) ? 'down' : '');
      } else {
        priceEl.className = 'price';
      }
      priceEl.textContent = `$${priceStr}`;
      lastPrice.set(sym, priceStr);

      // 24h 변동률 배지
      const chg = changePct.get(sym);
      const badge = document.getElementById('chg-'+sym);
      if(badge){
        if(typeof chg === 'number' && Math.abs(chg) >= 10){
          badge.style.display = 'inline-block';
          badge.className = 'badge ' + (chg > 0 ? 'up' : 'down');
          badge.textContent = `${chg.toFixed(2)}% ${chg>0?'상승':'하락'}`;
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // 탭 제목 업데이트
    function updateTitle(sym){
      const p = curPrice.get(sym);
      const tag = sym.replace('usdt','').toUpperCase();
      document.title = p ? `$${p} - ${tag}` : `로딩 중... - ${tag}`;
    }

    // 심볼 유효성 체크 (spot 심볼 여부)
    async function checkSymbolSpot(sym){
      try{
        const res = await fetch(`https://api.binance.com/api/v3/exchangeInfo?symbol=${sym.toUpperCase()}`);
        if(!res.ok) return false;
        const info = await res.json();
        if(!info.symbols || !info.symbols.length) return false;
        const s = info.symbols[0];
        // status가 TRADING 이고 quoteAsset이 USDT 인지 확인
        return s.status === 'TRADING' && s.quoteAsset === 'USDT';
      }catch(e){
        // CORS나 네트워크 이슈일 수 있으므로, 실패 시 일단 통과시켜 WebSocket에서 판단
        return true;
      }
    }

    async function fetch24hChanges(){
      // 병렬로 24h 변동률 조회 (CORS 정책에 따라 실패할 수 있음)
      await Promise.all(coins.map(async (sym)=>{
        try{
          const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym.toUpperCase()}`);
          if(!r.ok) return;
          const d = await r.json();
          const pct = parseFloat(d.priceChangePercent);
          if(!Number.isNaN(pct)) changePct.set(sym, pct);
        }catch(_){/* ignore */}
      }));
      // 이미 생성된 카드들에 즉시 반영
      coins.forEach(sym=>{
        const p = curPrice.get(sym);
        if(p) updateCard(sym, p);
      });
    }

    function connectWS(){
      if(ws){ try{ ws.close(); }catch(_){ } ws = null; }
      const url = `wss://stream.binance.com:9443/stream?streams=${buildStreams()}`;
      setStatus('실시간 연결 중…');
      ws = new WebSocket(url);

      ws.onopen = ()=>{
        setStatus('실시간 연결 완료');
        reconnectDelay = 1000; // 성공 시 딜레이 초기화
      };

      ws.onmessage = (evt)=>{
        try{
          const payload = JSON.parse(evt.data);
          const d = payload.data;
          if(!d || !d.s || !d.p) return;
          const sym = d.s.toLowerCase();
          // 소수 자리: JASMY는 6자리, 그 외 2자리 기본
          const priceStr = parseFloat(d.p).toFixed(sym==='jasmyusdt'?6:2);
          curPrice.set(sym, priceStr);
          updateCard(sym, priceStr);
          if(titleSel.value === sym) updateTitle(sym);
        }catch(e){ /* ignore */ }
      };

      ws.onclose = ()=>{
        setStatus('연결 끊김 – 재시도 중…');
        setTimeout(connectWS, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay*2, 30000);
      };

      ws.onerror = ()=>{
        setStatus('실시간 연결 오류 – 재시도 중…', true);
        try{ ws.close(); }catch(_){ }
      };
    }

    function rebuildUI(){
      // 제목 선택 박스와 그리드 모두 초기화 후 재구성
      titleSel.innerHTML = '';
      grid.innerHTML = '';

      // 알파벳 정렬
      coins.sort();
      coins.forEach(sym=>{
        ensureCard(sym);
        const opt = document.createElement('option');
        opt.value = sym; opt.textContent = displayName(sym);
        titleSel.appendChild(opt);
      });
      if(!coins.includes(titleSel.value)) titleSel.value = coins[0] || '';
      if(titleSel.value) updateTitle(titleSel.value);
    }

    async function addSymbolFromInput(){
      let raw = addInput.value; if(!raw) return;
      const sym = normalize(raw);
      addInput.value = '';
      if(coins.includes(sym)) { setStatus(`${displayName(sym)} 이미 추가됨`); return; }

      // (선택) 심볼 검증
      const ok = await checkSymbolSpot(sym);
      if(!ok){
        setStatus(`${displayName(sym)}: Binance 현물 심볼 아님 (추가 취소)`, true);
        return;
      }

      coins.push(sym);
      rebuildUI();
      connectWS();
      fetch24hChanges();
      setStatus(`${displayName(sym)} 추가됨`);
    }

    // 초기화
    (async function init(){
      // 초기 코인 -> usdt 붙여 정규화 후 중복 제거
      const set = new Set(initialCoins.map(c=>normalize(c)));
      coins = [...set];
      rebuildUI();
      connectWS();
      fetch24hChanges();
      // 변동률 주기적 갱신(5분)
      setInterval(fetch24hChanges, 5*60*1000);
    })();

    // 이벤트 바인딩
    addBtn.addEventListener('click', addSymbolFromInput);
    addInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addSymbolFromInput(); });
    refreshBtn.addEventListener('click', ()=>{ connectWS(); fetch24hChanges(); });
    titleSel.addEventListener('change', ()=> updateTitle(titleSel.value));
  </script>
</body>
</html>

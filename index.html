<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œë”© ì¤‘...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f1115;--card:#1a1d23;--panel:#12151c;--muted:#97a0b8;--ok:#00e676;--warn:#ffca28;--err:#ff5252;--border:#2a2f3a}
    *{box-sizing:border-box}
    body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;padding:0}
    .layout{display:grid;grid-template-columns: 1fr 320px;gap:16px;min-height:100vh;padding:20px}
    header{grid-column:1 / -1;text-align:center}
    h1{margin:0 0 8px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:8px auto 18px}
    .controls>*{background:#1f1f1f;color:#fff;border:none;border-radius:8px;padding:9px 11px;font-size:14px}
    .controls input{min-width:160px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);position:relative}
    .sym{font-weight:700;margin-bottom:6px;letter-spacing:.3px}
    .price{font-size:22px;font-weight:800;margin:6px 0}
    .up{color:var(--ok)}
    .down{color:var(--err)}
    .muted{opacity:.7;font-size:12px}
    .badge{display:inline-block;margin-top:6px;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.up{background:rgba(0,230,118,.15);color:var(--ok);border:1px solid rgba(0,230,118,.4)}
    .badge.down{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.4)}
    .del{position:absolute;top:8px;right:8px;background:#2a2f3a;border:1px solid #3a4150;border-radius:6px;font-size:12px;padding:4px 8px;color:#cfd6e6;cursor:pointer}
    .del:hover{background:#353c4b}
    .status{ text-align:center; margin:10px auto 0; font-size:12px; color:#aaa; max-width:960px }
    .error{ color:#ff8a80 }
    .log{white-space:pre-wrap;background:#101318;border:1px solid var(--border);border-radius:8px;padding:10px;max-width:960px;margin:10px auto 0;font-size:12px;color:#c7cfe2}
    /* ì˜¤ë¥¸ìª½ íŒ¨ë„ */
    aside.status-panel{position:sticky;top:20px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;height:fit-content}
    .row{display:flex;justify-content:space-between;gap:10px;font-size:14px}
    .k{opacity:.7}
    .v{font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .ok{background:rgba(0,230,118,.15);color:var(--ok);border:1px solid rgba(0,230,118,.4)}
    .err{background:rgba(255,82,82,.15);color:var(--err);border:1px solid rgba(255,82,82,.4)}
    .hr{height:1px;background:var(--border);margin:2px 0}
    .list{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px solid var(--border);background:#171a21;padding:4px 8px;border-radius:999px;font-size:12px}
    @media(max-width:960px){.layout{grid-template-columns:1fr}} /* ëª¨ë°”ì¼ì—ì„œëŠ” íŒ¨ë„ ì•„ë˜ë¡œ */
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>ë°”ì´ë‚¸ìŠ¤ ì‹¤ì‹œê°„ ì½”ì¸ ê°€ê²©</h1>
      <div class="controls">
        <label style="background:none;padding:0">íƒ­ ì œëª© ì½”ì¸</label>
        <select id="titleCoin"></select>
        <input id="addInput" placeholder="ì¶”ê°€í•  ì½”ì¸ (ì˜ˆ: ADA ë˜ëŠ” ADAUSDT)" />
        <button id="addBtn">ì½”ì¸ ì¶”ê°€</button>
        <button id="refreshBtn">ì—°ê²° ì¬ì‹œë„</button>
      </div>
    </header>

    <main>
      <div class="grid" id="grid"></div>
      <div class="status" id="status">ì´ˆê¸°í™” ì¤‘â€¦</div>
      <div class="log" id="log" style="display:none"></div>
    </main>

    <aside class="status-panel" id="panel">
      <div class="row"><span class="k">ì—°ê²° ìƒíƒœ</span><span class="v"><span id="connTag" class="tag ok">ì—°ê²°ë¨</span></span></div>
      <div class="row"><span class="k">ëª¨ë“œ</span><span class="v" id="mode">combined</span></div>
      <div class="row"><span class="k">ë§ˆì§€ë§‰ ìˆ˜ì‹ </span><span class="v" id="last">-</span></div>
      <div class="row"><span class="k">êµ¬ë… ì‹¬ë³¼</span><span class="v" id="count">0ê°œ</span></div>
      <div class="hr"></div>
      <div class="row"><span class="k">ì¬ì—°ê²° ëŒ€ê¸°</span><span class="v" id="backoff">1.0s</span></div>
      <div class="hr"></div>
      <div class="list" id="symbols"></div>
    </aside>
  </div>

  <script>
    // ===== ì´ˆê¸° ëª©ë¡ (ì•ŒíŒŒë²³) =====
    const initialCoins = [
      'ACM','ALICE','ALGO','APT','ASTR','BNB','BTC','CETUS','CRV','DYDX','DUSK','EIGEN','ETH','FIDA','FIL','FLOW','GMT','ICP','ICX','JASMY','NEAR','NEO','NMR','OG','POL','POWR','PUNDIX','QI','QNT','QTUM','RARE','RDNT','REI','SOL','T','TIA','WOO','XEC','XVG','YGG','ZEN','ZEC'
    ];

    // ===== ìƒíƒœ =====
    let coins = []; // ì†Œë¬¸ì usdt ì ‘ë¯¸ì–´
    const lastPrice = new Map();
    const curPrice  = new Map();
    const changePct = new Map();

    let ws = null;
    let reconnectDelay = 1000;
    let lastMsgTS = 0;
    let mode = 'combined'; // 'combined' | 'arr'
    let connected = false;

    const grid = document.getElementById('grid');
    const titleSel = document.getElementById('titleCoin');
    const addInput = document.getElementById('addInput');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    // íŒ¨ë„ ìš”ì†Œ
    const connTag = document.getElementById('connTag');
    const modeEl = document.getElementById('mode');
    const lastEl = document.getElementById('last');
    const countEl = document.getElementById('count');
    const backoffEl = document.getElementById('backoff');
    const symListEl = document.getElementById('symbols');

    function log(msg){
      logEl.style.display='block';
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function normalize(sym){
      if(!sym) return '';
      sym = sym.trim().toLowerCase();
      if(!sym) return '';
      return sym.endsWith('usdt') ? sym : sym + 'usdt';
    }
    function displayName(sym){
      return sym.replace('usdt','').toUpperCase() + '/USDT';
    }
    function buildStreams(){
      return coins.map(s => s + '@miniTicker').join('/'); // miniTickerê°€ tradeë³´ë‹¤ ì•ˆì •ì 
    }
    function setStatus(msg, err=false){
      statusEl.textContent = msg;
      statusEl.className = 'status' + (err?' error':'');
      log(msg);
    }

    function ensureCard(sym){
      if(document.getElementById(sym)) return;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <button class="del" data-sym="${sym}" title="ì‚­ì œ">ì‚­ì œ</button>
        <div class="sym">${displayName(sym)}</div>
        <div class="price" id="${sym}">ë¡œë”© ì¤‘â€¦</div>
        <div class="badge" id="chg-${sym}" style="display:none"></div>
        <div class="muted" id="note-${sym}"></div>
      `;
      grid.appendChild(card);
    }

    function updatePanel(){
      // ì—°ê²° íƒœê·¸
      connTag.textContent = connected ? 'ì—°ê²°ë¨' : 'ëŠê¹€';
      connTag.className = 'tag ' + (connected ? 'ok' : 'err');
      modeEl.textContent = mode;
      countEl.textContent = coins.length + 'ê°œ';
      backoffEl.textContent = (reconnectDelay/1000).toFixed(1) + 's';
      // ì‹¬ë³¼ ì¹©
      symListEl.innerHTML = '';
      coins.forEach(s=>{ const chip = document.createElement('div'); chip.className='chip'; chip.textContent=s.toUpperCase(); symListEl.appendChild(chip); });
    }

    function updateCard(sym, priceStr){
      const el = document.getElementById(sym);
      if(!el) return;
      const last = lastPrice.get(sym);
      if(last !== undefined){
        el.className = 'price ' + (parseFloat(priceStr) > parseFloat(last) ? 'up' : parseFloat(priceStr) < parseFloat(last) ? 'down' : '');
      } else { el.className = 'price'; }
      el.textContent = `$${priceStr}`;
      lastPrice.set(sym, priceStr);

      const chg = changePct.get(sym);
      const badge = document.getElementById('chg-'+sym);
      if(badge){
        if(typeof chg === 'number' && Math.abs(chg) >= 10){
          badge.style.display = 'inline-block';
          badge.className = 'badge ' + (chg>0?'up':'down');
          badge.textContent = `${chg.toFixed(2)}% ${chg>0?'ìƒìŠ¹':'í•˜ë½'}`;
        } else { badge.style.display = 'none'; }
      }
    }

    function dot(){ return connected ? 'ğŸŸ¢' : 'ğŸ”´'; }
    function updateTitle(sym){
      const p = curPrice.get(sym);
      const tag = sym.replace('usdt','').toUpperCase();
      document.title = p ? `${dot()} $${p} - ${tag}` : `${dot()} ë¡œë”© ì¤‘... - ${tag}`;
    }

    async function fetch24hChanges(){
      await Promise.all(coins.map(async sym=>{
        try{
          const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym.toUpperCase()}`);
          if(!r.ok) return; const d = await r.json();
          const pct = parseFloat(d.priceChangePercent);
          if(!Number.isNaN(pct)) changePct.set(sym, pct);
        }catch(e){ log(`24h ì‹¤íŒ¨ ${sym}: ${e?.message||e}`); }
      }));
      coins.forEach(sym=>{ const p = curPrice.get(sym); if(p) updateCard(sym,p); });
    }

    function connectWS(){
      if(ws){ try{ ws.close(); }catch(_){} ws=null; }
      lastMsgTS = Date.now();
      const url = (mode==='combined')
        ? `wss://stream.binance.com:9443/stream?streams=${buildStreams()}`
        : `wss://stream.binance.com:9443/ws/!miniTicker@arr`;

      setStatus(`ì‹¤ì‹œê°„ ì—°ê²° ì¤‘â€¦ (mode=${mode})`);
      ws = new WebSocket(url);

      ws.onopen = ()=>{ connected = true; setStatus('ì‹¤ì‹œê°„ ì—°ê²° ì™„ë£Œ'); reconnectDelay=1000; updatePanel(); updateTitle(titleSel.value); };

      ws.onmessage = (evt)=>{
        lastMsgTS = Date.now();
        if(!connected){ connected=true; updatePanel(); updateTitle(titleSel.value); }
        try{
          const payload = JSON.parse(evt.data);
          if(mode==='combined'){
            const d = payload.data; if(!d||!d.s) return;
            const sym = d.s.toLowerCase();
            const priceStr = parseFloat(d.c ?? d.p).toFixed(sym==='jasmyusdt'?6:2); // miniTicker.c or trade.p
            curPrice.set(sym, priceStr);
            updateCard(sym, priceStr);
            if(titleSel.value===sym) updateTitle(sym);
          } else { // arr mode: ë°°ì—´ ì „ì²´
            const arr = Array.isArray(payload) ? payload : payload.data;
            if(!Array.isArray(arr)) return;
            for(const it of arr){
              const s = it.s?.toLowerCase?.();
              if(!s || !coins.includes(s)) continue;
              const priceStr = parseFloat(it.c).toFixed(s==='jasmyusdt'?6:2);
              curPrice.set(s, priceStr);
              updateCard(s, priceStr);
              if(titleSel.value===s) updateTitle(s);
            }
          }
          lastEl.textContent = new Date().toLocaleTimeString();
        }catch(e){ log('ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨: '+(e?.message||e)); }
      };

      ws.onclose = ()=>{
        connected = false; updatePanel(); updateTitle(titleSel.value);
        setStatus('ì—°ê²° ëŠê¹€ â€“ ì¬ì‹œë„ ëŒ€ê¸°â€¦');
        setTimeout(()=>{ connectWS(); }, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay*2, 30000);
      };

      ws.onerror = (e)=>{
        connected = false; updatePanel(); updateTitle(titleSel.value);
        setStatus('ì‹¤ì‹œê°„ ì—°ê²° ì˜¤ë¥˜', true);
        log('WS error: '+(e?.message||e));
        try{ ws.close(); }catch(_){}
      };

      // 7ì´ˆ ë™ì•ˆ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ëª¨ë“œ ì „í™˜
      setTimeout(()=>{
        if(Date.now()-lastMsgTS > 7000){
          mode = (mode==='combined') ? 'arr' : 'combined';
          setStatus(`ë©”ì‹œì§€ ë¬´ì‘ë‹µ â†’ ëª¨ë“œ ì „í™˜: ${mode}`);
          updatePanel();
          connectWS();
        }
      }, 7500);
    }

    function rebuildUI(){
      const prevSel = titleSel.value;
      titleSel.innerHTML=''; grid.innerHTML='';
      coins.sort();
      coins.forEach(sym=>{
        ensureCard(sym);
        const opt = document.createElement('option');
        opt.value = sym; opt.textContent = displayName(sym);
        titleSel.appendChild(opt);
      });
      titleSel.value = coins.includes(prevSel) ? prevSel : (coins[0] || '');
      if(titleSel.value) updateTitle(titleSel.value);
      updatePanel();
    }

    function removeSymbol(sym){
      const idx = coins.indexOf(sym);
      if(idx === -1) return;
      coins.splice(idx,1);
      lastPrice.delete(sym); curPrice.delete(sym); changePct.delete(sym);
      const priceEl = document.getElementById(sym);
      if(priceEl){ const card = priceEl.closest('.card'); if(card) card.remove(); }
      if(titleSel.value === sym){
        titleSel.value = coins[0] || '';
        if(titleSel.value) updateTitle(titleSel.value); else document.title = 'ì½”ì¸ ê°€ê²©';
      }
      const prevSel = titleSel.value;
      titleSel.innerHTML='';
      coins.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=displayName(s); titleSel.appendChild(o); });
      titleSel.value = prevSel && coins.includes(prevSel) ? prevSel : (coins[0]||'');
      connectWS();
      fetch24hChanges();
      updatePanel();
      setStatus(`${displayName(sym)} ì œê±°ë¨`);
    }

    async function addSymbolFromInput(){
      let raw = addInput.value; if(!raw) return; addInput.value='';
      const sym = normalize(raw);
      if(coins.includes(sym)) { setStatus(`${displayName(sym)} ì´ë¯¸ ì¶”ê°€ë¨`); return; }
      coins.push(sym); rebuildUI(); connectWS(); fetch24hChanges();
      setStatus(`${displayName(sym)} ì¶”ê°€ë¨`);
    }

    // ì´ë²¤íŠ¸ ìœ„ì„: ì‚­ì œ ë²„íŠ¼
    document.getElementById('grid').addEventListener('click', (e)=>{
      const btn = e.target.closest('.del');
      if(!btn) return;
      const sym = btn.dataset.sym;
      if(sym) removeSymbol(sym);
    });

    (async function init(){
      const set = new Set(initialCoins.map(c=>normalize(c)));
      coins = [...set];
      rebuildUI();
      connectWS();
      fetch24hChanges();
      setInterval(fetch24hChanges, 5*60*1000);
      // íŒ¨ë„ ì‹œê°„ í‘œê¸° keep-alive
      setInterval(()=>{ lastEl.textContent = new Date().toLocaleTimeString(); }, 2000);
    })();

    addBtn.addEventListener('click', addSymbolFromInput);
    addInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addSymbolFromInput(); });
    refreshBtn.addEventListener('click', ()=>{ connectWS(); fetch24hChanges(); });
    titleSel.addEventListener('change', ()=> updateTitle(titleSel.value));
  </script>
</body>
</html>
